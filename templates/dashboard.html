<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="/static/style.css">
<meta name="viewport" content="width=device-width,initial-scale=1">
</head>
<body>

<div class="card">
  <h2>ğŸ§  Python Script Control Panel</h2>

  <input id="search" placeholder="ğŸ” Search script..." onkeyup="filterScripts()">

  <div class="row" style="margin-top:10px">
    <form action="/upload" method="post" enctype="multipart/form-data">
      <input type="file" name="file">
      <button type="submit">Upload</button>
    </form>

    <button onclick="restartAll()">ğŸ”„ Restart ALL</button>
  </div>
</div>

{% for f in files %}
<div class="card script" data-name="{{f}}" data-script="{{f}}">
  <h3>
    {{f}}
    {% if f in running %}
      <span class="running">â— RUNNING</span>
    {% else %}
      <span class="stopped">â— STOPPED</span>
    {% endif %}
  </h3>

  <small class="stats">CPU: 0% | RAM: 0MB</small>

  <div class="row">
    <button onclick="runScript('{{f}}')">â–¶ Run</button>
    <button class="stop" onclick="stopScript('{{f}}')">â¹ Stop</button>
    <button onclick="restartScript('{{f}}')">ğŸ” Restart</button>
    <button class="delete" onclick="deleteScript('{{f}}')">ğŸ—‘ Delete</button>
  </div>

  <label>
    <input type="checkbox" checked>
    Auto-scroll logs
  </label>

  <pre class="log"
       style="height:220px;overflow:auto;background:#020617;
              border-radius:10px;padding:8px"></pre>
</div>
{% endfor %}

<script>
function runScript(name){
 fetch("/run",{
   method:"POST",
   headers:{'Content-Type':'application/json'},
   body:JSON.stringify({name})
 })
}

function stopScript(name){
 fetch("/stop",{
   method:"POST",
   headers:{'Content-Type':'application/json'},
   body:JSON.stringify({name})
 })
}

function restartScript(name){
 fetch("/restart",{
   method:"POST",
   headers:{'Content-Type':'application/json'},
   body:JSON.stringify({name})
 })
}

function deleteScript(name){
 fetch("/delete",{
   method:"POST",
   headers:{'Content-Type':'application/json'},
   body:JSON.stringify({name})
 }).then(()=>location.reload())
}

function restartAll(){
 fetch("/restart-all",{method:"POST"})
}

function filterScripts(){
 let q=document.getElementById("search").value.toLowerCase()
 document.querySelectorAll(".script").forEach(s=>{
   s.style.display=s.dataset.name.toLowerCase().includes(q)?"block":"none"
 })
}

function updateAll(){
 document.querySelectorAll(".script").forEach(card=>{
   const name = card.dataset.script
   const logEl = card.querySelector(".log")
   const statEl = card.querySelector(".stats")
   const autoScroll = card.querySelector("input[type=checkbox]").checked

   fetch(`/log-text/${name}`)
     .then(r=>r.text())
     .then(t=>{
       logEl.textContent=t
       if(autoScroll) logEl.scrollTop=logEl.scrollHeight
     })

   fetch(`/stats/${name}`)
     .then(r=>r.json())
     .then(d=>{
       statEl.textContent = `CPU: ${d.cpu}% | RAM: ${d.ram}MB`
     })
 })
}

setInterval(updateAll,2000)
updateAll()
</script>

</body>
  </html>
